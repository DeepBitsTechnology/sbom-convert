project_name: manifest
before:
  hooks:
    - go mod tidy
    - ./scripts/completions.sh
    - ./scripts/manpages.sh
    - go generate ./...

builds:
  - env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin
    goarch:
      - "386"
      - amd64
      - arm
      - arm64
    flags:
      - -trimpath
    ldflags:
      - -s -w -X {{ .ModulePath }}/cmd/cli.version={{.Version}}
    main: .
checksum:
  name_template: 'checksums.txt'
snapshot:
  name_template: "{{ incpatch .Version }}-next"

# TODO: improve section: ref: https://github.com/goreleaser/goreleaser/blob/main/.goreleaser.yaml
changelog:
  sort: asc
  filters:
    exclude:
      - '^docs:'
      - '^test:'
      - "merge conflict"
      - Merge pull request
      - Merge remote-tracking branch
      - Merge branch
      - go mod tidy

release:
 disable: false
 name_template: 'v{{ .Version }}'
 github:
   owner: manifest-cyber
   name: cli

# snapcrafts:
#   - name_template: '{{ .ProjectName }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}'
#     name: manifest-cli
#     apps:
#       # The name of the app must be the same name as the binary built or the snapcraft name.
#       manifest:
#         command: manifest
#         aliases: ["manifest"]
#     summary: TODO
#     description: |
#       TODO
#     grade: stable
#     confinement: classic
#     publish: true

nfpms:
  - file_name_template: '{{ .ConventionalFileName }}'
    id: packages
    homepage: https://github.com/manifest-cyber/cli
    description: |-
      TODO
    maintainer: Ori Avraham <ori@manifestcyber.com>
    vendor: Manifest
    bindir: /usr/bin
    section: utils
    contents:
      - src: ./completions/manifest.bash
        dst: /usr/share/bash-completion/completions/manifest
        file_info:
          mode: 0644
      - src: ./completions/manifest.fish
        dst: /usr/share/fish/vendor_completions.d/manifest.fish
        file_info:
          mode: 0644
      - src: ./completions/manifest.zsh
        dst:  /usr/share/zsh/vendor-completions/_manifest
        file_info:
          mode: 0644
      - src: ./manpages/manifest.1.gz
        dst: /usr/share/man/man1/manifest.1.gz
        file_info:
          mode: 0644
      - src: ./LICENSE # TODO: change from MIT
        dst: /usr/share/doc/manifest/copyright
        file_info:
          mode: 0644
    formats:
    - apk
    - deb
    - rpm
    - archlinux
    dependencies:
    - git
    deb:
      lintian_overrides:
        - statically-linked-binary
        - changelog-file-missing-in-native-package

archives:
  - name_template: >-
      {{ .ProjectName }}_
      {{- title .Os | tolower }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}
    format_overrides:
    - goos: windows
      format: zip
    builds_info:
      group: root
      owner: root
    rlcp: true
    files:
      - README.md
      - LICENSE
      - completions/*
      - manpages/*

publishers:
  - name: fury.io
    ids:
    - packages
    env:
    - 'FURY_TOKEN={{ .Env.FURY_TOKEN }}'
    cmd: ./scripts/fury-upload.sh {{ .ArtifactName }}

# note: disabled due to chocolatey detects virus(?) and broken workflows
# chocolateys:
#   - authors: Ori Avraham
#     title: Manifest CLI
#     project_url: https://github.com/manifest-cyber/cli
#     url_template: "https://github.com/manifest-cyber/cli/releases/download/{{ .Tag }}/{{ .ArtifactName }}"
#     license_url: https://github.com/manifest-cyber/cli/blob/main/LICENSE
#     require_license_acceptance: false
#     docs_url: https://github.com/manifest-cyber/cli/blob/main/README.md
#     summary: A toolkit for sbom generation, merge and publish to the Manifest platform
#     description: |
#       {{ .ProjectName }} is a toolkit for sbom generation, merge and publish to the Manifest platform.
#     release_notes: "https://github.com/manifest-cyber/cli/releases/tag/v{{ .Version }}"
#     source_repo: https://push.chocolatey.org/
#     tags: manifest sbom cyber security
#     api_key: '{{ .Env.CHOCOLATEY_API_KEY }}'
scoop:
  bucket:
    owner: manifest-cyber
    name: scoop-bucket
  homepage: https://github.com/manifest-cyber/cli
  description: a toolkit for sbom generation, merge and publish to the Manifest platform
  license: MIT

brews:
  - tap:
      owner: manifest-cyber
      name: homebrew-tap
    homepage: https://github.com/manifest-cyber/cli
    goarm: "7"
    description:  a toolkit for sbom generation, merge and publish to the Manifest platform
    # license: MIT
    # dependencies: TODO
    folder: Formula
    install: |-
      bin.install "manifest"
      bash_completion.install "completions/manifest.bash" => "manifest"
      zsh_completion.install "completions/manifest.zsh" => "_manifest"
      fish_completion.install "completions/manifest.fish"
      man1.install "manpages/manifest.1.gz"

dockers:
- image_templates:
  - 'ghcr.io/manifest-cyber/cli:{{ .Tag }}-amd64'
  dockerfile: Dockerfile
  use: buildx
  build_flag_templates:
  - "--pull"
  - "--label=io.artifacthub.package.readme-url=https://raw.githubusercontent.com/manifest-cyber/cli/main/README.md"
  - "--label=io.artifacthub.package.logo-url=https://app.manifestcyber.com/logo192.png"
  - "--label=io.artifacthub.package.maintainers=[{\"name\":\"Ori Avraham\",\"email\":\"ori@manifestcyber.com\"}]"
  - "--label=io.artifacthub.package.license=MIT"
  - "--label=org.opencontainers.image.description=A toolkit for sbom generation, merge and publish to the Manifest platform"
  - "--label=org.opencontainers.image.created={{.Date}}"
  - "--label=org.opencontainers.image.name={{.ProjectName}}"
  - "--label=org.opencontainers.image.revision={{.FullCommit}}"
  - "--label=org.opencontainers.image.version={{.Version}}"
  - "--label=org.opencontainers.image.source=https://github.com/manifest-cyber/cli"
  - "--platform=linux/amd64"
  extra_files:
  - scripts/entrypoint.sh
  - scripts/cdxgen.sh
  - scripts/syft.sh
  - scripts/trivy.sh
  - scripts/spdx-sbom-generator.sh
- image_templates:
  - 'ghcr.io/manifest-cyber/cli:{{ .Tag }}-arm64'
  dockerfile: Dockerfile
  use: buildx
  build_flag_templates:
  - "--pull"
  - "--label=io.artifacthub.package.readme-url=https://raw.githubusercontent.com/manifest-cyber/cli/main/README.md"
  - "--label=io.artifacthub.package.logo-url=https://app.manifestcyber.com/logo192.png"
  - "--label=io.artifacthub.package.maintainers=[{\"name\":\"Ori Avraham\",\"email\":\"ori@manifestcyber.com\"}]"
  - "--label=io.artifacthub.package.license=MIT"
  - "--label=org.opencontainers.image.description=A toolkit for sbom generation, merge and publish to the Manifest platform"
  - "--label=org.opencontainers.image.created={{.Date}}"
  - "--label=org.opencontainers.image.name={{.ProjectName}}"
  - "--label=org.opencontainers.image.revision={{.FullCommit}}"
  - "--label=org.opencontainers.image.version={{.Version}}"
  - "--label=org.opencontainers.image.source=https://github.com/manifest-cyber/cli"
  - "--platform=linux/arm64"
  goarch: arm64
  extra_files:
  - scripts/entrypoint.sh
  - scripts/cdxgen.sh
  - scripts/syft.sh
  - scripts/trivy.sh
  - scripts/spdx-sbom-generator.sh
docker_manifests:
- name_template: 'ghcr.io/manifest-cyber/cli:{{ .Tag }}'
  image_templates:
  - 'ghcr.io/manifest-cyber/cli:{{ .Tag }}-amd64'
  - 'ghcr.io/manifest-cyber/cli:{{ .Tag }}-arm64'
- name_template: 'ghcr.io/manifest-cyber/cli:latest'
  image_templates:
  - 'ghcr.io/manifest-cyber/cli:{{ .Tag }}-amd64'
  - 'ghcr.io/manifest-cyber/cli:{{ .Tag }}-arm64'
